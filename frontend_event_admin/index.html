<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>í—¤ì´ì œë…¸ ì´ë²¤íŠ¸ ê´€ë¦¬ì</title>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #FDFAF7;
      margin: 0;
      padding: 24px;
      color: #111827;
    }
    h1 { margin: 0 0 16px; }

    .toolbar { display:flex; gap:8px; align-items:center; }

    button {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-primary { background: #0EA5E9; color: #fff; }
    .btn-danger { background: #dc2626; color: #fff; }
    .btn-ghost { background: #e5e7eb; }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      margin-top: 16px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.06);
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      font-size: 14px;
    }
    th {
      background: #f3f4f6;
      font-weight: 600;
    }
    tr:hover { background: #f9fafb; }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: #e5e7eb;
      display: inline-block;
    }
    .badge-active { background: #10b981; color: #fff; }
    .badge-expired { background: #6b7280; color: #fff; }
    .badge-scheduled { background: #3b82f6; color: #fff; }
    .badge-disabled { background: #ef4444; color: #fff; }

    .filters {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .filters input, .filters select {
      padding: 8px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
    }
    .tab {
      padding: 8px 16px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 14px;
      color: #6b7280;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
    }
    .tab.active {
      color: #0EA5E9;
      border-bottom-color: #0EA5E9;
      font-weight: 600;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
      overflow-y: auto;
    }
    .modal {
      width: min(1200px, 95%);
      max-height: calc(100vh - 32px);
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.2);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      margin: auto;
    }
    .modal-header {
      padding: 16px 18px;
      display:flex; align-items:center; justify-content: space-between;
      border-bottom: 1px solid #e5e7eb;
      background: #f9fafb;
      flex-shrink: 0;
    }
    .modal-body {
      padding: 16px 18px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      overflow-y: auto;
      flex: 1;
      min-height: 0;
    }
    .modal-footer {
      padding: 14px 18px;
      display:flex; justify-content: flex-end; gap: 8px;
      border-top: 1px solid #e5e7eb;
      background: #f9fafb;
      flex-shrink: 0;
    }

    .card {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px;
      background: #fff;
    }

    .field { display:flex; flex-direction: column; gap: 6px; margin-bottom: 10px; }
    .field label { font-size: 12px; color:#374151; font-weight: 600; }
    .field input, .field select, .field textarea {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
      background: #fff;
    }
    .field textarea { min-height: 92px; resize: vertical; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }

    .row { display:flex; gap: 10px; }
    .row > * { flex: 1; }

    .hint { font-size: 12px; color: #6b7280; line-height: 1.4; }

    .pill {
      display:inline-flex; gap:6px; align-items:center;
      padding: 6px 10px; border-radius: 999px;
      background:#f3f4f6; font-size: 12px; color:#111827;
    }

    .preview {
      border: 1px dashed #cbd5e1;
      border-radius: 12px;
      padding: 14px;
      background: #f8fafc;
      min-height: 140px;
    }
    .preview-title { font-weight: 700; margin-bottom: 6px; }
    .preview-desc { color:#374151; font-size: 14px; margin-bottom: 10px; }
    .preview-img {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #fff;
      height: 140px;
      object-fit: cover;
    }
    .splitline { height: 1px; background:#e5e7eb; margin: 10px 0; }

    .rule-builder {
      display:flex; flex-direction: column; gap: 10px;
    }
    .rule-row {
      display:flex; gap: 8px; align-items: center;
    }
    .rule-row select, .rule-row input { padding: 10px 12px; border-radius: 10px; border:1px solid #e5e7eb; }
    .rule-row .btn-danger { padding: 8px 10px; border-radius: 10px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }

    /* ìº í˜ì¸ ìš”ì•½ í—¤ë” */
    .campaign-summary {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 16px;
      border: 1px solid #e5e7eb;
    }
    .campaign-summary .badge {
      font-size: 11px;
      padding: 4px 8px;
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 26px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .toggle-slider {
      background-color: #10b981;
    }
    input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }
    .toggle-label {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .toggle-status {
      font-weight: 600;
      font-size: 14px;
    }
    .toggle-status.draft { color: #6b7280; }
    .toggle-status.active { color: #10b981; }

    /* CTA ê°•ì¡° ì¹´ë“œ */
    .cta-card {
      border: 2px solid #2563eb;
      background: #eff6ff;
      padding: 16px;
      border-radius: 12px;
      margin: 16px 0;
    }
    .cta-card.warning {
      border-color: #f59e0b;
      background: #fffbeb;
    }
    .cta-preview-btn {
      padding: 10px 20px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }
    .cta-preview-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    /* Rule Builder ê°œì„  */
    .rule-row {
      position: relative;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.2s;
    }
    .rule-row:hover {
      background: #f9fafb;
    }
    .rule-row .delete-btn {
      opacity: 0;
      transition: opacity 0.2s;
    }
    .rule-row:hover .delete-btn {
      opacity: 1;
    }
    .rule-empty-state {
      padding: 24px;
      text-align: center;
      color: #6b7280;
      background: #f9fafb;
      border-radius: 8px;
      border: 1px dashed #d1d5db;
    }

    /* ê³ ê¸‰ ì„¤ì • (Collapsible) */
    .advanced-section {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      margin: 16px 0;
      overflow: hidden;
    }
    .advanced-header {
      padding: 12px 16px;
      background: #f9fafb;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }
    .advanced-header:hover {
      background: #f3f4f6;
    }
    .advanced-content {
      padding: 16px;
      display: none;
    }
    .advanced-section.expanded .advanced-content {
      display: block;
    }
    .advanced-warning {
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
      padding: 12px;
      margin-top: 12px;
      border-radius: 4px;
      font-size: 13px;
    }

    /* Toast ì•Œë¦¼ */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #dc2626;
      color: white;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      display: none;
      animation: slideIn 0.3s ease;
    }
    .toast.show {
      display: block;
    }
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    .field.error input,
    .field.error select,
    .field.error textarea {
      border-color: #dc2626;
      background: #fef2f2;
    }
    .field-error-msg {
      color: #dc2626;
      font-size: 12px;
      margin-top: 4px;
    }
  </style>
</head>

<body>
  <h1>ğŸ¯ í—¤ì´ì œë…¸ ì´ë²¤íŠ¸ ê´€ë¦¬ì</h1>

  <div class="toolbar">
    <button class="btn-primary" onclick="openCreate()">+ ìº í˜ì¸ ìƒì„±</button>
    <span class="pill">API: <span class="mono" id="apiBaseLabel"></span></span>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('campaigns')">ìº í˜ì¸ ëª©ë¡</button>
    <button class="tab" onclick="switchTab('rewards')">ë¦¬ì›Œë“œ ì¡°íšŒ</button>
    <button class="tab" onclick="switchTab('impressions')">ë…¸ì¶œ ì¡°íšŒ</button>
    <button class="tab" onclick="switchTab('simulate')">ì‹œë®¬ë ˆì´ì…˜</button>
    <button class="tab" onclick="switchTab('guide')">ğŸ“– ì‚¬ìš© ê°€ì´ë“œ</button>
  </div>

  <!-- ìº í˜ì¸ ëª©ë¡ íƒ­ -->
  <div id="tabCampaigns">
    <div class="filters">
      <input type="text" id="filterKey" placeholder="í‚¤ ê²€ìƒ‰..." oninput="applyFilters()" />
      <select id="filterKind" onchange="applyFilters()">
        <option value="">ì „ì²´ ì¢…ë¥˜</option>
        <option value="EVENT">EVENT</option>
        <option value="NOTICE">NOTICE</option>
        <option value="AD">AD</option>
      </select>
      <select id="filterPlacement" onchange="applyFilters()">
        <option value="">ì „ì²´ ìœ„ì¹˜</option>
        <option value="HOME_MODAL">HOME_MODAL</option>
        <option value="HOME_BANNER">HOME_BANNER</option>
        <option value="NOTICE_CENTER">NOTICE_CENTER</option>
      </select>
      <select id="filterTemplate" onchange="applyFilters()">
        <option value="">ì „ì²´ í…œí”Œë¦¿</option>
        <option value="image_top">image_top</option>
        <option value="no_image">no_image</option>
        <option value="product_spotlight">product_spotlight</option>
      </select>
      <select id="filterEnabled" onchange="applyFilters()">
        <option value="">ì „ì²´ ìƒíƒœ</option>
        <option value="true">í™œì„±í™”</option>
        <option value="false">ë¹„í™œì„±í™”</option>
      </select>
    </div>

    <table>
      <thead>
        <tr>
          <th>Toggle</th>
          <th>Key</th>
          <th>Kind / Placement / Template</th>
          <th>Priority</th>
          <th>ê¸°ê°„</th>
          <th>Status</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="campaignTableBody"></tbody>
    </table>
  </div>

  <!-- ë¦¬ì›Œë“œ ì¡°íšŒ íƒ­ -->
  <div id="tabRewards" style="display:none;">
    <div class="filters">
      <input type="text" id="filterRewardUserId" placeholder="User ID (UUID)..." />
      <input type="text" id="filterRewardCampaignId" placeholder="Campaign ID (UUID)..." />
      <button class="btn-primary" onclick="loadRewards()">ì¡°íšŒ</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>User ID</th>
          <th>Campaign Key</th>
          <th>Status</th>
          <th>Granted At</th>
          <th>Idempotency Key</th>
        </tr>
      </thead>
      <tbody id="rewardsTableBody"></tbody>
    </table>
  </div>

  <!-- ë…¸ì¶œ ì¡°íšŒ íƒ­ -->
  <div id="tabImpressions" style="display:none;">
    <div class="filters">
      <input type="text" id="filterImpressionUserId" placeholder="User ID (UUID)..." />
      <input type="text" id="filterImpressionCampaignId" placeholder="Campaign ID (UUID)..." />
      <button class="btn-primary" onclick="loadImpressions()">ì¡°íšŒ</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>User ID</th>
          <th>Campaign Key</th>
          <th>Seen Count</th>
          <th>Last Seen At</th>
          <th>Suppress Until</th>
        </tr>
      </thead>
      <tbody id="impressionsTableBody"></tbody>
    </table>
  </div>

  <!-- ì‹œë®¬ë ˆì´ì…˜ íƒ­ -->
  <div id="tabSimulate" style="display:none;">
    <div class="card" style="max-width: 600px;">
      <div class="field">
        <label>User ID</label>
        <input type="text" id="simUserId" placeholder="UUID..." />
      </div>
      <div class="field">
        <label>Trigger</label>
        <select id="simTrigger">
          <option value="FIRST_TRACKING_CREATED">FIRST_TRACKING_CREATED</option>
          <option value="SIGNUP_COMPLETE">SIGNUP_COMPLETE</option>
          <option value="ALERT_CLICKED">ALERT_CLICKED</option>
          <option value="REFERRAL_CONFIRMED">REFERRAL_CONFIRMED</option>
        </select>
      </div>
      <div class="field">
        <label>Context (JSON, ì„ íƒ)</label>
        <textarea id="simContext" class="mono" placeholder='{"pet_type": "DOG", "locale": "ko"}'></textarea>
      </div>
      <button class="btn-primary" onclick="runSimulate()">ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰</button>
      <div id="simResult" style="margin-top: 16px;"></div>
    </div>
  </div>

  <!-- ì‚¬ìš© ê°€ì´ë“œ íƒ­ -->
  <div id="tabGuide" style="display:none;">
    <div class="card" style="max-width: 1000px; margin: 0 auto;">
      <div class="guide-section">
        <h2>ğŸ“š í—¤ì´ì œë…¸ ìº í˜ì¸ ê´€ë¦¬ì ì‚¬ìš© ê°€ì´ë“œ</h2>
        <p>ì´ í˜ì´ì§€ëŠ” í—¤ì´ì œë…¸ ì•±ì˜ ì´ë²¤íŠ¸/ê³µì§€/ê´‘ê³  ìº í˜ì¸ì„ ê´€ë¦¬í•˜ëŠ” ê´€ë¦¬ì ë„êµ¬ì…ë‹ˆë‹¤.</p>
      </div>

      <div class="guide-section">
        <h2>1. ìº í˜ì¸ ëª©ë¡</h2>
        <h3>ê¸°ëŠ¥ ì„¤ëª…</h3>
        <p>ë“±ë¡ëœ ëª¨ë“  ìº í˜ì¸ì„ ì¡°íšŒí•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        
        <h3>í•„í„°ë§</h3>
        <ul>
          <li><strong>í‚¤ ê²€ìƒ‰</strong>: ìº í˜ì¸ í‚¤ë¡œ ê²€ìƒ‰ (ì˜ˆ: <code>first_tracking_1000p</code>)</li>
          <li><strong>ì¢…ë¥˜</strong>: EVENT, NOTICE, AD ì¤‘ ì„ íƒ</li>
          <li><strong>ë…¸ì¶œ ìœ„ì¹˜</strong>: HOME_MODAL, HOME_BANNER, NOTICE_CENTER ì¤‘ ì„ íƒ</li>
          <li><strong>í…œí”Œë¦¿</strong>: image_top, no_image, product_spotlight ì¤‘ ì„ íƒ</li>
          <li><strong>ìƒíƒœ</strong>: í™œì„±í™”/ë¹„í™œì„±í™” í•„í„°</li>
        </ul>

        <h3>ìƒíƒœ ë°°ì§€ ì˜ë¯¸</h3>
        <ul>
          <li><span class="badge badge-active">ACTIVE_NOW</span>: í˜„ì¬ í™œì„±í™”ë˜ì–´ ì§„í–‰ ì¤‘ì¸ ìº í˜ì¸</li>
          <li><span class="badge badge-scheduled">SCHEDULED</span>: ì˜ˆì•½ë˜ì–´ ìˆì§€ë§Œ ì•„ì§ ì‹œì‘ë˜ì§€ ì•Šì€ ìº í˜ì¸</li>
          <li><span class="badge badge-expired">EXPIRED</span>: ì¢…ë£Œëœ ìº í˜ì¸</li>
          <li><span class="badge badge-disabled">DISABLED</span>: ë¹„í™œì„±í™”ëœ ìº í˜ì¸</li>
        </ul>

        <h3>ì£¼ìš” ê¸°ëŠ¥</h3>
        <ul>
          <li><strong>Toggle ë²„íŠ¼</strong>: ìº í˜ì¸ í™œì„±í™”/ë¹„í™œì„±í™” (ğŸŸ¢ = í™œì„±, âšª = ë¹„í™œì„±)</li>
          <li><strong>âœï¸ ìˆ˜ì •</strong>: ìº í˜ì¸ ì •ë³´ ìˆ˜ì •</li>
          <li><strong>ğŸ‘ï¸ ìƒì„¸</strong>: ìº í˜ì¸ ìƒì„¸ ì •ë³´ í™•ì¸</li>
        </ul>

        <div class="warning">
          <strong>âš ï¸ ì£¼ì˜ì‚¬í•­</strong><br>
          í™œì„±í™”ëœ ìº í˜ì¸ì„ ë¹„í™œì„±í™”í•˜ë©´ ì¦‰ì‹œ ì§€ê¸‰ì´ ì¤‘ë‹¨ë©ë‹ˆë‹¤. ì§€ê¸‰ ì•¡ì…˜ì´ ìˆëŠ” ìº í˜ì¸ì€ ì‚­ì œ ëŒ€ì‹  ì¢…ë£Œ ì²˜ë¦¬í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.
        </div>
      </div>

      <div class="guide-section">
        <h2>2. ìº í˜ì¸ ìƒì„±/ìˆ˜ì •</h2>
        <h3>ê¸°ë³¸ ì •ë³´</h3>
        <ul>
          <li><strong>key</strong>: ê³ ìœ  ì‹ë³„ì (ì˜ë¬¸/ìˆ«ì/ì–¸ë”ìŠ¤ì½”ì–´ ê¶Œì¥, ì¤‘ë³µ ë¶ˆê°€)</li>
          <li><strong>kind</strong>: EVENT (í¬ì¸íŠ¸/í˜œíƒ), NOTICE (ê³µì§€), AD (ê´‘ê³ /í”„ë¡œëª¨ì…˜)</li>
          <li><strong>placement</strong>: ë…¸ì¶œ ìœ„ì¹˜ (HOME_MODAL, HOME_BANNER, NOTICE_CENTER)</li>
          <li><strong>template</strong>: ë ˆì´ì•„ì›ƒ í…œí”Œë¦¿ (image_top, no_image, product_spotlight)</li>
          <li><strong>priority</strong>: ìš°ì„ ìˆœìœ„ (ì‘ì„ìˆ˜ë¡ ë¨¼ì € ë…¸ì¶œ, ê¸°ë³¸ê°’: 100)</li>
          <li><strong>is_enabled</strong>: í™œì„±í™” ì—¬ë¶€ (ê¸°ë³¸ê°’: false - ìš´ì˜ ì‹¤ìˆ˜ ë°©ì§€)</li>
        </ul>

        <h3>ê¸°ê°„ ì„¤ì •</h3>
        <ul>
          <li><strong>start_at</strong>: ìº í˜ì¸ ì‹œì‘ ì¼ì‹œ</li>
          <li><strong>end_at</strong>: ìº í˜ì¸ ì¢…ë£Œ ì¼ì‹œ (start_atë³´ë‹¤ ì´í›„ì—¬ì•¼ í•¨)</li>
        </ul>

        <h3>Content (ì½˜í…ì¸ )</h3>
        <ul>
          <li><strong>title</strong>: ìº í˜ì¸ ì œëª© (í•„ìˆ˜)</li>
          <li><strong>description</strong>: ìº í˜ì¸ ì„¤ëª…</li>
          <li><strong>image_url</strong>: ì´ë¯¸ì§€ URL (ì„ íƒ)</li>
          <li><strong>CTA ë²„íŠ¼ í…ìŠ¤íŠ¸</strong>: ë²„íŠ¼ì— í‘œì‹œë  í…ìŠ¤íŠ¸</li>
          <li><strong>CTA deeplink</strong>: ë²„íŠ¼ í´ë¦­ ì‹œ ì´ë™í•  ì•± ë‚´ ê²½ë¡œ</li>
        </ul>

        <h3>Rules (ê·œì¹™)</h3>
        <p>ìº í˜ì¸ ì ìš© ëŒ€ìƒ ì¡°ê±´ì„ ì„¤ì •í•©ë‹ˆë‹¤. Rule Builderë¥¼ ì‚¬ìš©í•˜ì—¬ ì¡°ê±´ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <ul>
          <li><strong>user.is_new</strong>: ì‹ ê·œ ìœ ì € ì—¬ë¶€</li>
          <li><strong>user.has_any_tracking</strong>: íŠ¸ë˜í‚¹ ì¡´ì¬ ì—¬ë¶€</li>
          <li><strong>user.days_since_signup</strong>: ê°€ì… ê²½ê³¼ì¼</li>
        </ul>
        <p>ê·œì¹™ì´ ì—†ìœ¼ë©´ ì „ì²´ ìœ ì €ì—ê²Œ ì ìš©ë©ë‹ˆë‹¤.</p>

        <h3>Actions (ì•¡ì…˜)</h3>
        <ul>
          <li><strong>trigger</strong>: íŠ¸ë¦¬ê±° ì´ë²¤íŠ¸
            <ul>
              <li>FIRST_TRACKING_CREATED: ì²« íŠ¸ë˜í‚¹ ìƒì„± ì‹œ</li>
              <li>SIGNUP_COMPLETE: íšŒì›ê°€ì… ì™„ë£Œ ì‹œ</li>
              <li>ALERT_CLICKED: ì•Œë¦¼ í´ë¦­ ì‹œ</li>
              <li>REFERRAL_CONFIRMED: ì¶”ì²œì¸ í™•ì¸ ì‹œ</li>
            </ul>
          </li>
          <li><strong>action_type</strong>: ì•¡ì…˜ íƒ€ì…
            <ul>
              <li>GRANT_POINTS: í¬ì¸íŠ¸ ì§€ê¸‰ (points í•„ìˆ˜)</li>
              <li>SHOW_ONLY: ë…¸ì¶œë§Œ (ì§€ê¸‰ ì—†ìŒ)</li>
            </ul>
          </li>
          <li><strong>points</strong>: GRANT_POINTSì¼ ë•Œ ì§€ê¸‰í•  í¬ì¸íŠ¸ (ì–‘ìˆ˜ í•„ìˆ˜)</li>
        </ul>

        <div class="card">
          <strong>ğŸ’¡ ìˆ˜ì • ì‹œ ì£¼ì˜ì‚¬í•­</strong><br>
          ìº í˜ì¸ ìˆ˜ì • ì‹œ Rulesì™€ ActionsëŠ” <strong>ì „ì²´ êµì²´</strong> ì „ëµì„ ì‚¬ìš©í•©ë‹ˆë‹¤. 
          ê¸°ì¡´ ê·œì¹™ê³¼ ì•¡ì…˜ì´ ëª¨ë‘ ì‚­ì œë˜ê³  ìƒˆë¡œ ì…ë ¥í•œ ë‚´ìš©ìœ¼ë¡œ êµì²´ë©ë‹ˆë‹¤.
        </div>
      </div>

      <div class="guide-section">
        <h2>3. ë¦¬ì›Œë“œ ì¡°íšŒ</h2>
        <p>ìœ ì €ì—ê²Œ ì§€ê¸‰ëœ ë¦¬ì›Œë“œ ë‚´ì—­ì„ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <ul>
          <li><strong>User ID</strong>: íŠ¹ì • ìœ ì €ì˜ ë¦¬ì›Œë“œë§Œ ì¡°íšŒ (ì„ íƒ)</li>
          <li><strong>Campaign ID</strong>: íŠ¹ì • ìº í˜ì¸ì˜ ë¦¬ì›Œë“œë§Œ ì¡°íšŒ (ì„ íƒ)</li>
        </ul>
        <h3>ì¡°íšŒ í•­ëª©</h3>
        <ul>
          <li><strong>User ID</strong>: ë¦¬ì›Œë“œë¥¼ ë°›ì€ ìœ ì €</li>
          <li><strong>Campaign Key</strong>: ìº í˜ì¸ ì‹ë³„ì</li>
          <li><strong>Status</strong>: GRANTED (ì§€ê¸‰ ì™„ë£Œ), FAILED (ì‹¤íŒ¨), PENDING (ëŒ€ê¸° ì¤‘)</li>
          <li><strong>Granted At</strong>: ì§€ê¸‰ ì¼ì‹œ</li>
          <li><strong>Idempotency Key</strong>: ì¤‘ë³µ ì§€ê¸‰ ë°©ì§€ìš© í‚¤</li>
        </ul>
      </div>

      <div class="guide-section">
        <h2>4. ë…¸ì¶œ ì¡°íšŒ</h2>
        <p>ìœ ì €ë³„ ìº í˜ì¸ ë…¸ì¶œ ê¸°ë¡ì„ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <ul>
          <li><strong>User ID</strong>: íŠ¹ì • ìœ ì €ì˜ ë…¸ì¶œ ê¸°ë¡ë§Œ ì¡°íšŒ (ì„ íƒ)</li>
          <li><strong>Campaign ID</strong>: íŠ¹ì • ìº í˜ì¸ì˜ ë…¸ì¶œ ê¸°ë¡ë§Œ ì¡°íšŒ (ì„ íƒ)</li>
        </ul>
        <h3>ì¡°íšŒ í•­ëª©</h3>
        <ul>
          <li><strong>User ID</strong>: ë…¸ì¶œì„ ë³¸ ìœ ì €</li>
          <li><strong>Campaign Key</strong>: ìº í˜ì¸ ì‹ë³„ì</li>
          <li><strong>Seen Count</strong>: ë…¸ì¶œ íšŸìˆ˜</li>
          <li><strong>Last Seen At</strong>: ë§ˆì§€ë§‰ ë…¸ì¶œ ì¼ì‹œ</li>
          <li><strong>Suppress Until</strong>: ë…¸ì¶œ ì–µì œ ì¢…ë£Œ ì¼ì‹œ (ì—†ìœ¼ë©´ -)</li>
        </ul>
      </div>

      <div class="guide-section">
        <h2>5. ì‹œë®¬ë ˆì´ì…˜</h2>
        <p>íŠ¹ì • ìœ ì €ì—ê²Œ ì–´ë–¤ ìº í˜ì¸ì´ ì ìš©ë˜ëŠ”ì§€ ë¯¸ë¦¬ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‹¤ì œ ì§€ê¸‰ì€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
        <h3>ì‚¬ìš© ë°©ë²•</h3>
        <ol>
          <li><strong>User ID</strong> ì…ë ¥ (UUID í˜•ì‹)</li>
          <li><strong>Trigger</strong> ì„ íƒ (FIRST_TRACKING_CREATED ë“±)</li>
          <li><strong>Context</strong> ì…ë ¥ (ì„ íƒ, JSON í˜•ì‹)
            <ul>
              <li>ì˜ˆ: <code>{"pet_type": "DOG", "locale": "ko", "app_version": "1.0.0"}</code></li>
            </ul>
          </li>
          <li><strong>ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰</strong> ë²„íŠ¼ í´ë¦­</li>
        </ol>
        <h3>ê²°ê³¼ í•´ì„</h3>
        <ul>
          <li><strong>ì ìš© ê°€ëŠ¥í•œ ìº í˜ì¸</strong>: ì¡°ê±´ì„ ë§Œì¡±í•˜ì—¬ ì ìš©ë  ìº í˜ì¸ ëª©ë¡</li>
          <li><strong>action</strong>: ì‹¤í–‰ë  ì•¡ì…˜ (ì˜ˆ: í¬ì¸íŠ¸ ì§€ê¸‰ ì •ë³´)</li>
        </ul>
        <div class="success">
          <strong>âœ… í™œìš© íŒ</strong><br>
          ìƒˆ ìº í˜ì¸ì„ ìƒì„±í•˜ê¸° ì „ì— ì‹œë®¬ë ˆì´ì…˜ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•˜ì—¬ ì˜ˆìƒëŒ€ë¡œ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
        </div>
      </div>

      <div class="guide-section">
        <h2>6. ìš´ì˜ ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>
        <p>ìº í˜ì¸ì„ ìƒì„±/ìˆ˜ì •í•  ë•Œ ë‹¤ìŒ ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”:</p>
        <ul>
          <li>âœ… ìº í˜ì¸ keyê°€ ëª…í™•í•˜ê³  ì¤‘ë³µë˜ì§€ ì•ŠëŠ”ê°€?</li>
          <li>âœ… ê¸°ê°„ì´ ê²¹ì¹˜ëŠ” ìº í˜ì¸ì´ priorityë¡œ ì˜¬ë°”ë¥´ê²Œ ì •ë ¬ë˜ëŠ”ê°€?</li>
          <li>âœ… FIRST_TRACKING_CREATED íŠ¸ë¦¬ê±° ì‚¬ìš© ì‹œ ì¤‘ë³µ ì§€ê¸‰ ë°©ì§€ê°€ í™•ì¸ë˜ì—ˆëŠ”ê°€?</li>
          <li>âœ… toggle OFF ì‹œ ì¦‰ì‹œ ì§€ê¸‰ì´ ì¤‘ë‹¨ë˜ëŠ”ê°€?</li>
          <li>âœ… simulate ê²°ê³¼ì™€ ì‹¤ì œ ì§€ê¸‰ ê²°ê³¼ê°€ ì¼ì¹˜í•˜ëŠ”ê°€?</li>
          <li>âœ… GRANT_POINTS ì•¡ì…˜ì˜ points ê°’ì´ ì–‘ìˆ˜ì¸ê°€?</li>
          <li>âœ… start_atì´ end_atë³´ë‹¤ ì´ì „ì¸ê°€?</li>
        </ul>
      </div>

      <div class="guide-section">
        <h2>7. ì£¼ìš” ê°œë…</h2>
        <h3>ìº í˜ì¸ ìƒíƒœ</h3>
        <p>ìº í˜ì¸ì€ ë‹¤ìŒ ì¡°ê±´ì— ë”°ë¼ ìë™ìœ¼ë¡œ ìƒíƒœê°€ ê³„ì‚°ë©ë‹ˆë‹¤:</p>
        <ul>
          <li><strong>ACTIVE_NOW</strong>: is_enabled = true AND í˜„ì¬ ì‹œê°„ì´ start_atê³¼ end_at ì‚¬ì´</li>
          <li><strong>SCHEDULED</strong>: is_enabled = true AND í˜„ì¬ ì‹œê°„ < start_at</li>
          <li><strong>EXPIRED</strong>: is_enabled = true AND í˜„ì¬ ì‹œê°„ > end_at</li>
          <li><strong>DISABLED</strong>: is_enabled = false</li>
        </ul>

        <h3>ì¤‘ë³µ ì§€ê¸‰ ë°©ì§€</h3>
        <p>ì‹œìŠ¤í…œì€ ë‹¤ìŒ ë©”ì»¤ë‹ˆì¦˜ìœ¼ë¡œ ì¤‘ë³µ ì§€ê¸‰ì„ ë°©ì§€í•©ë‹ˆë‹¤:</p>
        <ul>
          <li><strong>Idempotency Key</strong>: ê° ì§€ê¸‰ì— ê³ ìœ  í‚¤ ë¶€ì—¬</li>
          <li><strong>Unique Constraint</strong>: user_id + campaign_id + action_id ì¡°í•©ìœ¼ë¡œ ì¤‘ë³µ ì°¨ë‹¨</li>
          <li><strong>ì„œë²„ ì¸¡ ê²€ì¦</strong>: FIRST_TRACKING_CREATED ì‹œì ì— user tracking count == 1 í™•ì¸</li>
        </ul>

        <h3>Priority (ìš°ì„ ìˆœìœ„)</h3>
        <p>ì—¬ëŸ¬ ìº í˜ì¸ì´ ë™ì‹œì— í™œì„±í™”ë˜ì–´ ìˆì„ ë•Œ, priority ê°’ì´ ì‘ì„ìˆ˜ë¡ ë¨¼ì € ë…¸ì¶œë©ë‹ˆë‹¤.</p>
        <ul>
          <li>ì˜ˆ: priority 10ì¸ ìº í˜ì¸ì´ priority 100ì¸ ìº í˜ì¸ë³´ë‹¤ ë¨¼ì € ë…¸ì¶œ</li>
          <li>ê¸°ë³¸ê°’: 100</li>
        </ul>
      </div>

      <div class="guide-section">
        <h2>8. ë¬¸ì œ í•´ê²°</h2>
        <h3>ìº í˜ì¸ì´ ë…¸ì¶œë˜ì§€ ì•Šì„ ë•Œ</h3>
        <ul>
          <li>ìº í˜ì¸ ìƒíƒœê°€ ACTIVE_NOWì¸ì§€ í™•ì¸</li>
          <li>ê¸°ê°„(start_at, end_at)ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸</li>
          <li>Rules ì¡°ê±´ì´ ë„ˆë¬´ ì œí•œì ì¸ì§€ í™•ì¸</li>
          <li>Priorityê°€ ë‹¤ë¥¸ ìº í˜ì¸ë³´ë‹¤ ë†’ì€ì§€ í™•ì¸</li>
        </ul>

        <h3>ë¦¬ì›Œë“œê°€ ì§€ê¸‰ë˜ì§€ ì•Šì„ ë•Œ</h3>
        <ul>
          <li>ìº í˜ì¸ì´ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸</li>
          <li>Triggerê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸</li>
          <li>Rules ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ”ì§€ í™•ì¸ (ì‹œë®¬ë ˆì´ì…˜ ì‚¬ìš©)</li>
          <li>ì´ë¯¸ ì§€ê¸‰ëœ ê¸°ë¡ì´ ìˆëŠ”ì§€ í™•ì¸ (ë¦¬ì›Œë“œ ì¡°íšŒ íƒ­)</li>
        </ul>

        <h3>ì—ëŸ¬ ë©”ì‹œì§€</h3>
        <ul>
          <li><strong>"ìº í˜ì¸ í‚¤ëŠ” ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤"</strong>: ë‹¤ë¥¸ ìº í˜ì¸ê³¼ keyê°€ ì¤‘ë³µë¨</li>
          <li><strong>"end_atì€ start_atë³´ë‹¤ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤"</strong>: ê¸°ê°„ ì„¤ì • ì˜¤ë¥˜</li>
          <li><strong>"GRANT_POINTSì¼ ë•Œ action.pointsëŠ” ì–‘ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤"</strong>: í¬ì¸íŠ¸ ê°’ ì˜¤ë¥˜</li>
        </ul>
      </div>

      <div class="guide-section">
        <h2>9. API ì—”ë“œí¬ì¸íŠ¸</h2>
        <p>ì´ ê´€ë¦¬ì í˜ì´ì§€ëŠ” ë‹¤ìŒ APIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:</p>
        <ul>
          <li><code>GET /admin/campaigns</code>: ìº í˜ì¸ ëª©ë¡ ì¡°íšŒ</li>
          <li><code>GET /admin/campaigns/{id}</code>: ìº í˜ì¸ ìƒì„¸ ì¡°íšŒ</li>
          <li><code>POST /admin/campaigns</code>: ìº í˜ì¸ ìƒì„±</li>
          <li><code>PUT /admin/campaigns/{id}</code>: ìº í˜ì¸ ìˆ˜ì •</li>
          <li><code>POST /admin/campaigns/{id}/toggle</code>: ìº í˜ì¸ í™œì„±í™”/ë¹„í™œì„±í™”</li>
          <li><code>POST /admin/campaigns/simulate</code>: ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰</li>
          <li><code>GET /admin/rewards</code>: ë¦¬ì›Œë“œ ì¡°íšŒ</li>
          <li><code>GET /admin/impressions</code>: ë…¸ì¶œ ì¡°íšŒ</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop" onclick="backdropClose(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div>
          <div style="font-weight:800;">ìº í˜ì¸ ìƒì„±</div>
          <div class="hint">EVENT/NOTICE/ADë¥¼ í•œ í™”ë©´ì—ì„œ ë“±ë¡í•©ë‹ˆë‹¤. ê·œì¹™(rule_json)ê³¼ ì•¡ì…˜(íŠ¸ë¦¬ê±°/í¬ì¸íŠ¸)ë„ ê°™ì´ ì €ì¥.</div>
        </div>
        <button class="btn-ghost" onclick="closeModal()">ë‹«ê¸°</button>
      </div>

      <div class="modal-body">
        <!-- Left: Form -->
        <div class="card">
          <div class="field">
            <label>key (ê³ ìœ ) <span style="color:#dc2626;">*</span></label>
            <input id="f_key" placeholder="first_tracking_1000p" />
            <div class="hint">ì˜ë¬¸/ìˆ«ì/ì–¸ë”ìŠ¤ì½”ì–´ ê¶Œì¥. unique.</div>
            <div class="field-error-msg" id="error_key"></div>
          </div>

          <div class="row">
            <div class="field">
              <label>kind <span style="color:#dc2626;">*</span></label>
              <select id="f_kind" onchange="syncSummary()">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="EVENT">EVENT (í¬ì¸íŠ¸/í˜œíƒ)</option>
                <option value="NOTICE">NOTICE (ê³µì§€)</option>
                <option value="AD">AD (ê´‘ê³ /í”„ë¡œëª¨ì…˜)</option>
              </select>
              <div class="field-error-msg" id="error_kind"></div>
            </div>
            <div class="field">
              <label>placement <span style="color:#dc2626;">*</span></label>
              <select id="f_placement" onchange="syncSummary()">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="HOME_MODAL">HOME_MODAL</option>
                <option value="HOME_BANNER">HOME_BANNER</option>
                <option value="NOTICE_CENTER">NOTICE_CENTER</option>
              </select>
              <div class="field-error-msg" id="error_placement"></div>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>template</label>
              <select id="f_template" onchange="syncPreview(); syncSummary();">
                <option value="image_top">image_top</option>
                <option value="no_image">no_image</option>
                <option value="product_spotlight">product_spotlight</option>
              </select>
            </div>
            <div class="field">
              <label>priority</label>
              <input id="f_priority" type="number" value="100" onchange="syncSummary()" />
            </div>
          </div>

          <div class="field">
            <label>ë°°í¬ ìƒíƒœ</label>
            <div class="toggle-label">
              <label class="toggle-switch">
                <input type="checkbox" id="f_enabled" onchange="syncToggleStatus(); syncSummary();" />
                <span class="toggle-slider"></span>
              </label>
              <span class="toggle-status" id="toggleStatusText">ì„ì‹œ ì €ì¥ (Draft)</span>
            </div>
            <div id="toggleWarning" style="display:none; margin-top:8px; padding:10px; background:#fef3c7; border-left:4px solid #f59e0b; border-radius:4px; font-size:13px;">
              âš  í™œì„±í™” ì‹œ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ì‚¬ìš©ìì—ê²Œ ì¦‰ì‹œ ë…¸ì¶œë©ë‹ˆë‹¤.
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>start_at <span style="color:#dc2626;">*</span></label>
              <input id="f_start" type="datetime-local" onchange="syncSummary()" />
              <div class="field-error-msg" id="error_start"></div>
            </div>
            <div class="field">
              <label>end_at <span style="color:#dc2626;">*</span></label>
              <input id="f_end" type="datetime-local" onchange="syncSummary()" />
              <div class="field-error-msg" id="error_end"></div>
            </div>
          </div>

          <div class="field">
            <label>title <span style="color:#dc2626;">*</span></label>
            <input id="f_title" placeholder="ì²« íŠ¸ë˜í‚¹ ë“±ë¡ ì‹œ 1000P ğŸ" oninput="syncPreview()" />
            <div class="field-error-msg" id="error_title"></div>
          </div>

          <div class="field">
            <label>description</label>
            <input id="f_desc" placeholder="ê°€ê²© ì•Œë¦¼ 1ê°œë§Œ ë“±ë¡í•´ë„ 1000í¬ì¸íŠ¸!" oninput="syncPreview()" />
          </div>

          <div class="field">
            <label>image_url (ì„ íƒ)</label>
            <input id="f_image" placeholder="https://cdn.../event.png" oninput="syncPreview()" />
          </div>

          <!-- CTA ê°•ì¡° ì¹´ë“œ -->
          <div class="cta-card" id="ctaCard">
            <div style="font-weight:700; margin-bottom:12px; color:#2563eb;">ğŸ¯ CTA (Call to Action)</div>
            <div class="field">
              <label>CTA ë²„íŠ¼ í…ìŠ¤íŠ¸ <span style="color:#dc2626;">*</span></label>
              <input id="f_btn_text" placeholder="ì§€ê¸ˆ ë“±ë¡í•˜ê¸°" oninput="syncPreview(); syncCTAWarning();" />
              <div class="field-error-msg" id="error_btn_text"></div>
            </div>
            <div class="field">
              <label>CTA deeplink <span style="color:#dc2626;">*</span></label>
              <input id="f_btn_link" placeholder="app://tracking/create" oninput="syncCTAWarning();" />
              <div class="hint">ë”¥ë§í¬ê°€ ì—†ìœ¼ë©´ ë²„íŠ¼ì´ ë™ì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
              <div class="field-error-msg" id="error_btn_link"></div>
            </div>
            <div id="ctaWarning" style="display:none; margin-top:8px; padding:10px; background:#fef3c7; border-left:4px solid #f59e0b; border-radius:4px; font-size:13px; color:#92400e;">
              âš  CTA ë”¥ë§í¬ê°€ ì—†ìœ¼ë©´ ë²„íŠ¼ì´ ë™ì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </div>
          </div>

          <div class="splitline"></div>

          <!-- Rule Builder -->
          <div style="font-weight:800; margin-bottom:10px;">Rule Builder</div>
          <div class="hint" style="margin-bottom:10px;">
            ì´ ìº í˜ì¸ì´ ëˆ„êµ¬ì—ê²Œ ë…¸ì¶œë ì§€ ì¡°ê±´ì„ ì„¤ì •í•©ë‹ˆë‹¤.<br>
            ì¡°ê±´ì€ ê¸°ë³¸ ANDë¡œ ë™ì‘í•©ë‹ˆë‹¤.
          </div>

          <div class="rule-builder" id="ruleBuilder"></div>
          <div id="ruleEmptyState" class="rule-empty-state" style="display:none;">
            ì¡°ê±´ì´ ì—†ìœ¼ë©´ ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ë…¸ì¶œë©ë‹ˆë‹¤.
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="btn-ghost" onclick="addRuleRow()">+ ì¡°ê±´ ì¶”ê°€</button>
            <button class="btn-ghost" onclick="resetRules()">ì´ˆê¸°í™”</button>
          </div>

          <div class="field" style="margin-top:16px;">
            <label>rule_json (ìë™ ìƒì„±ë¨)</label>
            <textarea id="f_rule_json" class="mono" readonly style="min-height:60px;"></textarea>
          </div>

          <!-- ê³ ê¸‰ ì„¤ì • (Collapsible) -->
          <div class="advanced-section" id="advancedSection">
            <div class="advanced-header" onclick="toggleAdvanced()">
              <span style="font-weight:600;">âš™ï¸ ê³ ê¸‰ ìº í˜ì¸ ì„¤ì •</span>
              <span id="advancedToggle">â–¼</span>
            </div>
            <div class="advanced-content">
              <div class="advanced-warning">
                âš ï¸ ê³ ê¸‰ ì„¤ì •ì€ ì„œë²„ ë¡œì§ê³¼ ì—°ë™ë©ë‹ˆë‹¤. ë³€ê²½ ì‹œ ì£¼ì˜í•˜ì„¸ìš”.
              </div>
              <div class="row" style="margin-top:16px;">
                <div class="field">
                  <label>trigger</label>
                  <select id="f_trigger">
                    <option value="FIRST_TRACKING_CREATED">FIRST_TRACKING_CREATED</option>
                    <option value="SIGNUP_COMPLETE">SIGNUP_COMPLETE</option>
                    <option value="ALERT_CLICKED">ALERT_CLICKED</option>
                    <option value="REFERRAL_CONFIRMED">REFERRAL_CONFIRMED</option>
                  </select>
                  <div class="hint">ì„œë²„ê°€ ì´ triggerë¥¼ ë°›ìœ¼ë©´ rules í‰ê°€ í›„ actions ì‹¤í–‰í•©ë‹ˆë‹¤.</div>
                </div>

                <div class="field">
                  <label>action_type</label>
                  <select id="f_action_type" onchange="syncActionUi()">
                    <option value="GRANT_POINTS">GRANT_POINTS</option>
                    <option value="SHOW_ONLY">SHOW_ONLY</option>
                  </select>
                </div>
              </div>

              <div class="field" id="pointsWrap">
                <label>points</label>
                <input id="f_points" type="number" value="1000" />
                <div class="hint">GRANT_POINTSì¼ ë•Œë§Œ ì‚¬ìš©.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: Preview -->
        <div class="card">
          <div style="font-weight:800; margin-bottom:10px;">ë¯¸ë¦¬ë³´ê¸°</div>
          
          <!-- ìº í˜ì¸ ìš”ì•½ í—¤ë” -->
          <div class="campaign-summary" id="campaignSummary">
            <span class="badge" id="sum_kind">-</span>
            <span class="badge" id="sum_placement">-</span>
            <span class="badge" id="sum_period">-</span>
            <span class="badge" id="sum_priority">Priority -</span>
            <span class="badge" id="sum_status">Draft</span>
          </div>

          <div class="preview">
            <div class="preview-title" id="pv_title">ì œëª©</div>
            <div class="preview-desc" id="pv_desc">ì„¤ëª…</div>
            <img id="pv_img" class="preview-img" alt="preview" />
            <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
              <button class="cta-preview-btn" id="pv_btn" disabled>CTA</button>
              <span class="badge" id="pv_meta"></span>
            </div>
          </div>

          <div class="hint" style="margin-top:10px;">
            âš ï¸ ë ˆì´ì•„ì›ƒ(ì´ë¯¸ì§€ ìœ„ì¹˜)ì€ templateë¡œë§Œ ì œì–´í•©ë‹ˆë‹¤. (image_top / no_image / product_spotlight)
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-ghost" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn-primary" id="submitBtn" onclick="submitCreate()">ì„ì‹œ ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- Toast ì•Œë¦¼ -->
  <div class="toast" id="toast">
    <div id="toastMessage"></div>
  </div>
    </div>
  </div>

  <script>
    const API_BASE = "/admin"; // í•„ìš” ì‹œ ë³€ê²½
    document.getElementById("apiBaseLabel").textContent = API_BASE;

    // ------- Tab switching -------
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      
      // ëª¨ë“  íƒ­ ìˆ¨ê¸°ê¸° (null ì²´í¬)
      const tabs = ['tabCampaigns', 'tabRewards', 'tabImpressions', 'tabSimulate', 'tabGuide'];
      tabs.forEach(tabId => {
        const el = document.getElementById(tabId);
        if (el) el.style.display = 'none';
      });
      
      if (tab === 'campaigns') {
        const tabEl = document.querySelectorAll('.tab')[0];
        const contentEl = document.getElementById('tabCampaigns');
        if (tabEl) tabEl.classList.add('active');
        if (contentEl) contentEl.style.display = 'block';
      } else if (tab === 'rewards') {
        const tabEl = document.querySelectorAll('.tab')[1];
        const contentEl = document.getElementById('tabRewards');
        if (tabEl) tabEl.classList.add('active');
        if (contentEl) contentEl.style.display = 'block';
      } else if (tab === 'impressions') {
        const tabEl = document.querySelectorAll('.tab')[2];
        const contentEl = document.getElementById('tabImpressions');
        if (tabEl) tabEl.classList.add('active');
        if (contentEl) contentEl.style.display = 'block';
      } else if (tab === 'simulate') {
        const tabEl = document.querySelectorAll('.tab')[3];
        const contentEl = document.getElementById('tabSimulate');
        if (tabEl) tabEl.classList.add('active');
        if (contentEl) contentEl.style.display = 'block';
      } else if (tab === 'guide') {
        const tabEl = document.querySelectorAll('.tab')[4];
        const contentEl = document.getElementById('tabGuide');
        if (tabEl) tabEl.classList.add('active');
        if (contentEl) contentEl.style.display = 'block';
      }
    }

    // ------- List -------
    let allCampaigns = [];

    async function loadCampaigns() {
      const params = new URLSearchParams();
      const key = document.getElementById("filterKey")?.value;
      const kind = document.getElementById("filterKind")?.value;
      const placement = document.getElementById("filterPlacement")?.value;
      const template = document.getElementById("filterTemplate")?.value;
      const enabled = document.getElementById("filterEnabled")?.value;

      if (key) params.append("key", key);
      if (kind) params.append("kind", kind);
      if (placement) params.append("placement", placement);
      if (template) params.append("template", template);
      if (enabled) params.append("enabled", enabled === "true");

      const res = await fetch(`${API_BASE}/campaigns?${params}`);
      allCampaigns = await res.json();

      renderCampaigns();
    }

    function applyFilters() {
      loadCampaigns();
    }

    function renderCampaigns() {
      const tbody = document.getElementById("campaignTableBody");
      tbody.innerHTML = "";

      allCampaigns.forEach(c => {
        const status = c.status || "DISABLED";
        const statusClass = {
          "ACTIVE_NOW": "badge-active",
          "EXPIRED": "badge-expired",
          "SCHEDULED": "badge-scheduled",
          "DISABLED": "badge-disabled"
        }[status] || "badge";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <button class="btn-ghost" onclick="toggleCampaign('${c.id}', ${!c.is_enabled})" title="${c.is_enabled ? 'ë„ê¸°' : 'ì¼œê¸°'}">
              ${c.is_enabled ? "ğŸŸ¢" : "âšª"}
            </button>
          </td>
          <td><strong>${escapeHtml(c.key)}</strong></td>
          <td>
            <span class="badge">${escapeHtml(c.kind)}</span>
            <span class="badge">${escapeHtml(c.placement)}</span>
            <span class="badge">${escapeHtml(c.template)}</span>
          </td>
          <td>${c.priority}</td>
          <td>${formatDateTime(c.start_at)} ~ ${formatDateTime(c.end_at)}</td>
          <td><span class="badge ${statusClass}">${status}</span></td>
          <td>
            <div class="row" style="gap: 4px;">
              <button class="btn-ghost" onclick="openEdit('${c.id}')" title="ìˆ˜ì •">âœï¸</button>
              <button class="btn-ghost" onclick="openDetail('${c.id}')" title="ìƒì„¸">ğŸ‘ï¸</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function toggleCampaign(id, enabled) {
      if (enabled && !confirm("ì´ ìº í˜ì¸ì„ í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      
      await fetch(`${API_BASE}/campaigns/${id}/toggle`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ is_enabled: enabled })
      });
      loadCampaigns();
    }

    async function openEdit(campaignId) {
      const res = await fetch(`${API_BASE}/campaigns/${campaignId}`);
      const campaign = await res.json();
      
      // í¼ ì±„ìš°ê¸°
      document.getElementById("f_key").value = campaign.key;
      document.getElementById("f_kind").value = campaign.kind;
      document.getElementById("f_placement").value = campaign.placement;
      document.getElementById("f_template").value = campaign.template;
      document.getElementById("f_priority").value = campaign.priority;
      document.getElementById("f_enabled").value = campaign.is_enabled ? "true" : "false";
      
      const start = new Date(campaign.start_at);
      const end = new Date(campaign.end_at);
      document.getElementById("f_start").value = toLocalInputValue(start);
      document.getElementById("f_end").value = toLocalInputValue(end);
      
      const content = campaign.content || {};
      document.getElementById("f_title").value = content.title || "";
      document.getElementById("f_desc").value = content.description || "";
      document.getElementById("f_image").value = content.image_url || "";
      document.getElementById("f_btn_text").value = content.cta?.text || "";
      document.getElementById("f_btn_link").value = content.cta?.deeplink || "";
      
      if (campaign.actions && campaign.actions.length > 0) {
        const action = campaign.actions[0];
        document.getElementById("f_trigger").value = action.trigger;
        document.getElementById("f_action_type").value = action.action_type;
        if (action.action && action.action.points) {
          document.getElementById("f_points").value = action.action.points;
        }
      }
      
      // Rules ë¡œë“œ
      if (campaign.rules && campaign.rules.length > 0) {
        const rule = campaign.rules[0];
        if (rule.all && Array.isArray(rule.all)) {
          ruleRows = rule.all.map(r => ({
            key: r.key,
            op: r.op,
            valueType: typeof r.value === "number" ? "number" : "bool",
            value: r.value
          }));
          renderRuleBuilder();
          syncRuleJson();
        }
      }
      
      syncActionUi();
      syncPreview();
      
      // ëª¨ë‹¬ ì œëª© ë³€ê²½
      document.querySelector(".modal-header > div > div").textContent = "ìº í˜ì¸ ìˆ˜ì •";
      document.querySelector(".modal-footer button.btn-primary").textContent = "ìˆ˜ì •";
      document.querySelector(".modal-footer button.btn-primary").onclick = () => submitUpdate(campaignId);
      
      document.getElementById("modalBackdrop").style.display = "flex";
    }

    async function openDetail(campaignId) {
      const res = await fetch(`${API_BASE}/campaigns/${campaignId}`);
      const campaign = await res.json();
      
      alert(`ìº í˜ì¸ ìƒì„¸\n\nKey: ${campaign.key}\nStatus: ${campaign.status}\nKind: ${campaign.kind}\nPriority: ${campaign.priority}\n\nRules: ${JSON.stringify(campaign.rules, null, 2)}\n\nActions: ${JSON.stringify(campaign.actions, null, 2)}`);
    }

    async function loadRewards() {
      const userId = document.getElementById("filterRewardUserId").value;
      const campaignId = document.getElementById("filterRewardCampaignId").value;
      
      const params = new URLSearchParams();
      if (userId) params.append("user_id", userId);
      if (campaignId) params.append("campaign_id", campaignId);
      
      const res = await fetch(`${API_BASE}/rewards?${params}`);
      const rewards = await res.json();
      
      const tbody = document.getElementById("rewardsTableBody");
      tbody.innerHTML = "";
      
      rewards.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(r.user_id)}</td>
          <td>${escapeHtml(r.campaign_key)}</td>
          <td><span class="badge">${escapeHtml(r.status)}</span></td>
          <td>${r.granted_at ? formatDateTime(r.granted_at) : "-"}</td>
          <td>${escapeHtml(r.idempotency_key || "-")}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function loadImpressions() {
      const userId = document.getElementById("filterImpressionUserId").value;
      const campaignId = document.getElementById("filterImpressionCampaignId").value;
      
      const params = new URLSearchParams();
      if (userId) params.append("user_id", userId);
      if (campaignId) params.append("campaign_id", campaignId);
      
      const res = await fetch(`${API_BASE}/impressions?${params}`);
      const impressions = await res.json();
      
      const tbody = document.getElementById("impressionsTableBody");
      tbody.innerHTML = "";
      
      impressions.forEach(i => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(i.user_id)}</td>
          <td>${escapeHtml(i.campaign_key)}</td>
          <td>${i.seen_count}</td>
          <td>${formatDateTime(i.last_seen_at)}</td>
          <td>${i.suppress_until ? formatDateTime(i.suppress_until) : "-"}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function runSimulate() {
      const userId = document.getElementById("simUserId").value.trim();
      const trigger = document.getElementById("simTrigger").value;
      const contextText = document.getElementById("simContext").value.trim();
      
      if (!userId) return alert("User IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      
      let context = {};
      if (contextText) {
        try {
          context = JSON.parse(contextText);
        } catch (e) {
          return alert("Context JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
      }
      
      const res = await fetch(`${API_BASE}/campaigns/simulate`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_id: userId,
          trigger: trigger,
          context: context
        })
      });
      
      const result = await res.json();
      
      const resultEl = document.getElementById("simResult");
      resultEl.innerHTML = `
        <div class="card">
          <h3>ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼</h3>
          <p><strong>ì ìš© ê°€ëŠ¥í•œ ìº í˜ì¸:</strong> ${result.eligible_campaigns.length}ê°œ</p>
          <pre class="mono" style="background: #f3f4f6; padding: 12px; border-radius: 8px; overflow: auto;">${JSON.stringify(result, null, 2)}</pre>
        </div>
      `;
    }

    // ------- Modal open/close -------
    function openCreate() {
      // í¼ ì´ˆê¸°í™”
      document.getElementById("f_key").value = "";
      document.getElementById("f_title").value = "";
      document.getElementById("f_desc").value = "";
      document.getElementById("f_image").value = "";
      document.getElementById("f_btn_text").value = "";
      document.getElementById("f_btn_link").value = "";
      document.getElementById("f_priority").value = "100";
      document.getElementById("f_kind").value = "";
      document.getElementById("f_placement").value = "";
      document.getElementById("f_template").value = "image_top";
      document.getElementById("f_trigger").value = "FIRST_TRACKING_CREATED";
      document.getElementById("f_action_type").value = "GRANT_POINTS";
      document.getElementById("f_points").value = "1000";
      document.getElementById("f_enabled").checked = false;

      // ì—ëŸ¬ ë©”ì‹œì§€ ì´ˆê¸°í™”
      document.querySelectorAll(".field-error-msg").forEach(el => el.textContent = "");
      document.querySelectorAll(".field").forEach(f => f.classList.remove("error"));

      // set defaults
      const now = new Date();
      const start = new Date(now.getTime() + 10 * 60 * 1000); // +10m
      const end = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000); // +7d
      document.getElementById("f_start").value = toLocalInputValue(start);
      document.getElementById("f_end").value = toLocalInputValue(end);

      resetRules(); // sets rule_json too
      syncActionUi();
      syncPreview();
      syncSummary();
      syncToggleStatus();
      syncCTAWarning();

      // ê³ ê¸‰ ì„¤ì • ì ‘ê¸°
      document.getElementById("advancedSection").classList.remove("expanded");
      document.getElementById("advancedToggle").textContent = "â–¼";

      // ëª¨ë‹¬ ì œëª© ë° ë²„íŠ¼ ì´ˆê¸°í™”
      document.querySelector(".modal-header > div > div").textContent = "ìº í˜ì¸ ìƒì„±";
      document.getElementById("submitBtn").textContent = "ì„ì‹œ ì €ì¥";
      document.getElementById("submitBtn").onclick = submitCreate;

      document.getElementById("modalBackdrop").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("modalBackdrop").style.display = "none";
    }

    function backdropClose(e) {
      if (e.target.id === "modalBackdrop") closeModal();
    }

    // ------- Rule Builder -------
    // Allowed keys (ì„œë²„ì—ì„œë„ ë™ì¼í•˜ê²Œ í•´ì„ ê°€ëŠ¥í•˜ë„ë¡ keyë¥¼ ê³ ì •)
    const RULE_KEYS = [
      { key: "user.is_new", label: "ì‹ ê·œìœ ì €(user.is_new)" },
      { key: "user.has_any_tracking", label: "íŠ¸ë˜í‚¹ ì¡´ì¬(user.has_any_tracking)" },
      { key: "user.days_since_signup", label: "ê°€ì…ê²½ê³¼ì¼(user.days_since_signup)" }
    ];
    const OPS = [
      { op: "eq", label: "=" },
      { op: "ne", label: "!=" },
      { op: "gt", label: ">" },
      { op: "gte", label: ">=" },
      { op: "lt", label: "<" },
      { op: "lte", label: "<=" }
    ];

    let ruleRows = [];

    function resetRules() {
      ruleRows = [
        { key: "user.is_new", op: "eq", valueType: "bool", value: true }
      ];
      renderRuleBuilder();
      syncRuleJson();
    }

    function addRuleRow() {
      ruleRows.push({ key: "user.has_any_tracking", op: "eq", valueType: "bool", value: false });
      renderRuleBuilder();
      syncRuleJson();
    }

    function removeRuleRow(idx) {
      ruleRows.splice(idx, 1);
      renderRuleBuilder();
      syncRuleJson();
    }

    function renderRuleBuilder() {
      const el = document.getElementById("ruleBuilder");
      el.innerHTML = "";

      ruleRows.forEach((r, idx) => {
        const row = document.createElement("div");
        row.className = "rule-row";

        const keySel = document.createElement("select");
        RULE_KEYS.forEach(k => {
          const opt = document.createElement("option");
          opt.value = k.key; opt.textContent = k.label;
          if (k.key === r.key) opt.selected = true;
          keySel.appendChild(opt);
        });
        keySel.onchange = () => {
          r.key = keySel.value;
          // keyì— ë”°ë¼ valueType ê¸°ë³¸ê°’ ì„¸íŒ…
          if (r.key === "user.days_since_signup") {
            r.valueType = "number";
            r.op = "lte";
            r.value = 7;
          } else {
            r.valueType = "bool";
            r.op = "eq";
            r.value = true;
          }
          renderRuleBuilder();
          syncRuleJson();
        };

        const opSel = document.createElement("select");
        OPS.forEach(o => {
          const opt = document.createElement("option");
          opt.value = o.op; opt.textContent = o.label;
          if (o.op === r.op) opt.selected = true;
          opSel.appendChild(opt);
        });
        opSel.onchange = () => { r.op = opSel.value; syncRuleJson(); };

        const valInput = document.createElement("input");
        if (r.valueType === "number") {
          valInput.type = "number";
          valInput.value = String(r.value ?? 0);
          valInput.oninput = () => { r.value = Number(valInput.value); syncRuleJson(); };
        } else {
          valInput.type = "text";
          valInput.value = (r.value === true) ? "true" : "false";
          valInput.oninput = () => {
            const v = valInput.value.trim().toLowerCase();
            r.value = (v === "true");
            syncRuleJson();
          };
        }
        valInput.className = "mono";

        const delBtn = document.createElement("button");
        delBtn.className = "btn-danger delete-btn";
        delBtn.textContent = "ì‚­ì œ";
        delBtn.onclick = () => {
          if (confirm("ì´ ì¡°ê±´ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            removeRuleRow(idx);
          }
        };

        row.appendChild(keySel);
        row.appendChild(opSel);
        row.appendChild(valInput);
        row.appendChild(delBtn);

        el.appendChild(row);
      });

      // ë¹ˆ ìƒíƒœ í‘œì‹œ
      const emptyState = document.getElementById("ruleEmptyState");
      if (ruleRows.length === 0) {
        emptyState.style.display = "block";
      } else {
        emptyState.style.display = "none";
      }
    }

    function syncRuleJson() {
      const rule = {
        all: ruleRows.map(r => ({
          op: r.op,
          key: r.key,
          value: r.value
        }))
      };
      document.getElementById("f_rule_json").value = JSON.stringify(rule, null, 2);
    }

    // ------- Action UI -------
    function syncActionUi() {
      const type = document.getElementById("f_action_type").value;
      document.getElementById("pointsWrap").style.display = (type === "GRANT_POINTS") ? "block" : "none";
    }

    // ------- Preview -------
    const previewInputs = ["f_title","f_desc","f_image","f_btn_text","f_kind","f_placement","f_template"];
    previewInputs.forEach(id => {
      document.addEventListener("input", (e) => {
        if (e.target && e.target.id === id) syncPreview();
      });
      document.addEventListener("change", (e) => {
        if (e.target && e.target.id === id) syncPreview();
      });
    });

    function syncPreview() {
      const title = document.getElementById("f_title").value || "ì œëª©";
      const desc = document.getElementById("f_desc").value || "ì„¤ëª…";
      const img = document.getElementById("f_image").value || "";
      const btn = document.getElementById("f_btn_text").value || "CTA";
      const btnLink = document.getElementById("f_btn_link").value || "";
      const kind = document.getElementById("f_kind").value;
      const placement = document.getElementById("f_placement").value;
      const template = document.getElementById("f_template").value;

      document.getElementById("pv_title").textContent = title;
      document.getElementById("pv_desc").textContent = desc;
      document.getElementById("pv_btn").textContent = btn;
      document.getElementById("pv_btn").disabled = !btnLink;
      document.getElementById("pv_meta").textContent = `${kind || "-"} â€¢ ${placement || "-"} â€¢ ${template}`;

      const imgEl = document.getElementById("pv_img");
      if (template === "no_image") {
        imgEl.style.display = "none";
      } else {
        imgEl.style.display = "block";
        imgEl.src = img || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='240'%3E%3Crect width='100%25' height='100%25' fill='%23e5e7eb'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%236b7280' font-family='Arial' font-size='18'%3Eimage%20preview%3C/text%3E%3C/svg%3E";
      }
    }

    // ìº í˜ì¸ ìš”ì•½ í—¤ë” ì—…ë°ì´íŠ¸
    function syncSummary() {
      const kind = document.getElementById("f_kind").value;
      const placement = document.getElementById("f_placement").value;
      const start = document.getElementById("f_start").value;
      const end = document.getElementById("f_end").value;
      const priority = document.getElementById("f_priority").value;
      const enabled = document.getElementById("f_enabled").checked;

      document.getElementById("sum_kind").textContent = kind || "-";
      document.getElementById("sum_placement").textContent = placement || "-";
      
      if (start && end) {
        const startDate = new Date(start).toISOString().slice(0, 10);
        const endDate = new Date(end).toISOString().slice(0, 10);
        document.getElementById("sum_period").textContent = `${startDate} ~ ${endDate}`;
      } else {
        document.getElementById("sum_period").textContent = "-";
      }
      
      document.getElementById("sum_priority").textContent = `Priority ${priority || "-"}`;
      
      const statusEl = document.getElementById("sum_status");
      if (enabled) {
        statusEl.textContent = "ACTIVE";
        statusEl.className = "badge badge-active";
      } else {
        statusEl.textContent = "Draft";
        statusEl.className = "badge badge-disabled";
      }
    }

    // Toggle ìƒíƒœ ì—…ë°ì´íŠ¸
    function syncToggleStatus() {
      const enabled = document.getElementById("f_enabled").checked;
      const statusText = document.getElementById("toggleStatusText");
      const warning = document.getElementById("toggleWarning");
      const submitBtn = document.getElementById("submitBtn");

      if (enabled) {
        statusText.textContent = "í™œì„±í™” (ë°°í¬)";
        statusText.className = "toggle-status active";
        warning.style.display = "block";
        submitBtn.textContent = "ì €ì¥ ë° ë°°í¬";
      } else {
        statusText.textContent = "ì„ì‹œ ì €ì¥ (Draft)";
        statusText.className = "toggle-status draft";
        warning.style.display = "none";
        submitBtn.textContent = "ì„ì‹œ ì €ì¥";
      }
    }

    // CTA ê²½ê³  í‘œì‹œ
    function syncCTAWarning() {
      const btnText = document.getElementById("f_btn_text").value.trim();
      const btnLink = document.getElementById("f_btn_link").value.trim();
      const warning = document.getElementById("ctaWarning");
      const ctaCard = document.getElementById("ctaCard");

      if (btnText && !btnLink) {
        warning.style.display = "block";
        ctaCard.classList.add("warning");
      } else {
        warning.style.display = "none";
        ctaCard.classList.remove("warning");
      }
    }

    // ê³ ê¸‰ ì„¤ì • í† ê¸€
    function toggleAdvanced() {
      const section = document.getElementById("advancedSection");
      const toggle = document.getElementById("advancedToggle");
      
      section.classList.toggle("expanded");
      toggle.textContent = section.classList.contains("expanded") ? "â–²" : "â–¼";
    }

    // Toast ì•Œë¦¼ í‘œì‹œ
    function showToast(message) {
      const toast = document.getElementById("toast");
      const toastMsg = document.getElementById("toastMessage");
      toastMsg.textContent = message;
      toast.classList.add("show");
      
      setTimeout(() => {
        toast.classList.remove("show");
      }, 3000);
    }

    // í•„ìˆ˜ê°’ ê²€ì¦
    function validateForm() {
      let isValid = true;
      const errors = {};

      // ì—ëŸ¬ ì´ˆê¸°í™”
      document.querySelectorAll(".field-error-msg").forEach(el => el.textContent = "");
      document.querySelectorAll(".field").forEach(f => f.classList.remove("error"));

      // key ê²€ì¦
      const key = document.getElementById("f_key").value.trim();
      if (!key) {
        errors.key = "keyëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.";
        isValid = false;
      }

      // kind ê²€ì¦
      const kind = document.getElementById("f_kind").value;
      if (!kind) {
        errors.kind = "kindë¥¼ ì„ íƒí•˜ì„¸ìš”.";
        isValid = false;
      }

      // placement ê²€ì¦
      const placement = document.getElementById("f_placement").value;
      if (!placement) {
        errors.placement = "placementë¥¼ ì„ íƒí•˜ì„¸ìš”.";
        isValid = false;
      }

      // start_at / end_at ê²€ì¦
      const start = document.getElementById("f_start").value;
      const end = document.getElementById("f_end").value;
      if (!start) {
        errors.start = "start_atì„ ì…ë ¥í•˜ì„¸ìš”.";
        isValid = false;
      }
      if (!end) {
        errors.end = "end_atì„ ì…ë ¥í•˜ì„¸ìš”.";
        isValid = false;
      }
      if (start && end && new Date(start) >= new Date(end)) {
        errors.end = "end_atì€ start_atë³´ë‹¤ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.";
        isValid = false;
      }

      // title ê²€ì¦
      const title = document.getElementById("f_title").value.trim();
      if (!title) {
        errors.title = "titleì€ í•„ìˆ˜ì…ë‹ˆë‹¤.";
        isValid = false;
      }

      // CTA ê²€ì¦
      const btnText = document.getElementById("f_btn_text").value.trim();
      const btnLink = document.getElementById("f_btn_link").value.trim();
      if (btnText && !btnLink) {
        errors.btn_link = "CTA í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ deeplinkë„ í•„ìˆ˜ì…ë‹ˆë‹¤.";
        isValid = false;
      }
      if (!btnText && btnLink) {
        errors.btn_text = "CTA deeplinkê°€ ìˆìœ¼ë©´ í…ìŠ¤íŠ¸ë„ í•„ìˆ˜ì…ë‹ˆë‹¤.";
        isValid = false;
      }

      // ì—ëŸ¬ í‘œì‹œ
      Object.keys(errors).forEach(field => {
        const errorEl = document.getElementById(`error_${field}`);
        const fieldEl = document.getElementById(`f_${field}`)?.closest(".field");
        if (errorEl) errorEl.textContent = errors[field];
        if (fieldEl) fieldEl.classList.add("error");
      });

      return { isValid, firstError: Object.keys(errors)[0] };
    }

    function buildPayload() {
      syncRuleJson(); // ensure latest

      const ruleJson = document.getElementById("f_rule_json").value.trim();
      let rules = [];
      if (ruleJson) {
        try {
          const rule = JSON.parse(ruleJson);
          // ruleì´ {all: [...]} í˜•íƒœì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
          rules = [rule];
        } catch (e) {
          throw new Error("rule_json í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
      }

      const actionType = document.getElementById("f_action_type").value;
      const actions = [{
        trigger: document.getElementById("f_trigger").value,
        action_type: actionType,
        action: (actionType === "GRANT_POINTS")
          ? { points: Number(document.getElementById("f_points").value || 0) }
          : {}
      }];

      return {
        key: document.getElementById("f_key").value.trim(),
        kind: document.getElementById("f_kind").value,
        placement: document.getElementById("f_placement").value,
        template: document.getElementById("f_template").value,
        priority: Number(document.getElementById("f_priority").value || 100),
        start_at: new Date(document.getElementById("f_start").value).toISOString(),
        end_at: new Date(document.getElementById("f_end").value).toISOString(),
        is_enabled: document.getElementById("f_enabled").checked,

        content: {
          title: document.getElementById("f_title").value || "",
          description: document.getElementById("f_desc").value || "",
          image_url: document.getElementById("f_image").value || "",
          cta: {
            text: document.getElementById("f_btn_text").value || "",
            deeplink: document.getElementById("f_btn_link").value || ""
          }
        },

        rules: rules,
        actions: actions
      };
    }

    // ------- Create submit -------
    async function submitCreate() {
      try {
        // í•„ìˆ˜ê°’ ê²€ì¦
        const validation = validateForm();
        if (!validation.isValid) {
          showToast("í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
          if (validation.firstError) {
            const fieldEl = document.getElementById(`f_${validation.firstError}`);
            if (fieldEl) {
              fieldEl.focus();
              fieldEl.scrollIntoView({ behavior: "smooth", block: "center" });
            }
          }
          return;
        }

        const payload = buildPayload();

        // ì¶”ê°€ ê²€ì¦
        if (payload.actions[0].action_type === "GRANT_POINTS" && (!payload.actions[0].action.points || payload.actions[0].action.points <= 0)) {
          showToast("GRANT_POINTSì¼ ë•Œ pointsëŠ” ì–‘ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
          document.getElementById("f_points").focus();
          return;
        }

        // í™œì„±í™” ì „ confirm
        if (payload.is_enabled) {
          if (!confirm("âš  í™œì„±í™” ì‹œ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ì‚¬ìš©ìì—ê²Œ ì¦‰ì‹œ ë…¸ì¶œë©ë‹ˆë‹¤.\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            return;
          }
        }

        const res = await fetch(`${API_BASE}/campaigns`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const txt = await res.text();
          console.error(txt);
          showToast("ì €ì¥ ì‹¤íŒ¨: " + txt);
          return;
        }

        showToast(payload.is_enabled ? "ìº í˜ì¸ì´ ì €ì¥ë˜ê³  ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤." : "ìº í˜ì¸ì´ ì„ì‹œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        closeModal();
        loadCampaigns();
      } catch (e) {
        showToast("ì˜¤ë¥˜: " + e.message);
      }
    }

    // ------- Update submit -------
    async function submitUpdate(campaignId) {
      try {
        // í•„ìˆ˜ê°’ ê²€ì¦
        const validation = validateForm();
        if (!validation.isValid) {
          showToast("í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
          if (validation.firstError) {
            const fieldEl = document.getElementById(`f_${validation.firstError}`);
            if (fieldEl) {
              fieldEl.focus();
              fieldEl.scrollIntoView({ behavior: "smooth", block: "center" });
            }
          }
          return;
        }

        const payload = buildPayload();

        // ì¶”ê°€ ê²€ì¦
        if (payload.actions[0].action_type === "GRANT_POINTS" && (!payload.actions[0].action.points || payload.actions[0].action.points <= 0)) {
          showToast("GRANT_POINTSì¼ ë•Œ pointsëŠ” ì–‘ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
          document.getElementById("f_points").focus();
          return;
        }

        // í™œì„±í™” ì „ confirm
        if (payload.is_enabled) {
          if (!confirm("âš  í™œì„±í™” ì‹œ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ì‚¬ìš©ìì—ê²Œ ì¦‰ì‹œ ë…¸ì¶œë©ë‹ˆë‹¤.\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            return;
          }
        }

        const res = await fetch(`${API_BASE}/campaigns/${campaignId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const txt = await res.text();
          console.error(txt);
          showToast("ìˆ˜ì • ì‹¤íŒ¨: " + txt);
          return;
        }

        showToast("ìº í˜ì¸ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        closeModal();
        loadCampaigns();
      } catch (e) {
        showToast("ì˜¤ë¥˜: " + e.message);
      }
    }

    // ------- Utils -------
    function toLocalInputValue(date) {
      const pad = (n) => String(n).padStart(2, "0");
      const yyyy = date.getFullYear();
      const mm = pad(date.getMonth() + 1);
      const dd = pad(date.getDate());
      const hh = pad(date.getHours());
      const mi = pad(date.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    }

    function formatDate(d) {
      try { return new Date(d).toISOString().slice(0, 10); }
      catch { return ""; }
    }

    function formatDateTime(d) {
      try {
        const date = new Date(d);
        return date.toLocaleString("ko-KR", { 
          year: "numeric", 
          month: "2-digit", 
          day: "2-digit", 
          hour: "2-digit", 
          minute: "2-digit" 
        });
      } catch { return ""; }
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // init
    resetRules();
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ API_BASE í™•ì¸ ë° ì•ˆë‚´
    if (window.location.protocol === 'file:') {
      console.warn('âš ï¸ file:// í”„ë¡œí† ì½œë¡œ ì—´ë ¸ìŠµë‹ˆë‹¤. HTTP ì„œë²„ë¥¼ í†µí•´ ì‹¤í–‰í•˜ì„¸ìš”.');
      const apiBaseEl = document.getElementById("apiBaseLabel");
      if (apiBaseEl) {
        apiBaseEl.textContent = API_BASE + " (ë¡œì»¬ ì„œë²„ í•„ìš”)";
        apiBaseEl.style.color = "#dc2626";
      }
    }
    
    // ì´ˆê¸° ë¡œë“œëŠ” ì—ëŸ¬ ë¬´ì‹œ (ì„œë²„ê°€ ì—†ì„ ìˆ˜ ìˆìŒ)
    loadCampaigns().catch(() => {
      console.log("ì´ˆê¸° ìº í˜ì¸ ë¡œë“œ ì‹¤íŒ¨ (ì„œë²„ ë¯¸ì‹¤í–‰ ê°€ëŠ¥)");
    });
  </script>
</body>
</html>
